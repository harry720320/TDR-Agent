<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDR Agent - Natural Language API Query</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .query-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .api-endpoint {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        .response-section {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error: error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-500 text-white">
                            <div className="text-center p-8">
                                <h1 className="text-2xl mb-4">Something went wrong</h1>
                                <p className="mb-4">Error: {this.state.error?.message}</p>
                                <button 
                                    onClick={() => window.location.reload()} 
                                    className="bg-white text-red-500 px-4 py-2 rounded hover:bg-gray-100"
                                >
                                    Reload Page
                                </button>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        function App() {
            console.log('App component initializing...');
            
            const [query, setQuery] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [suggestions, setSuggestions] = useState([]);
            const [endpoints, setEndpoints] = useState([]);
            const [config, setConfig] = useState({ 
                hostname: '', 
                api_token: '', 
                openrouter_api_key: '', 
                ai_provider: 'deepseek',
                openrouter_model: 'deepseek/deepseek-chat',
                openrouter_base_url: 'https://openrouter.ai/api/v1'
            });
            
            // Define available models for each provider
            const modelOptions = {
                'openai': [
                    { value: 'openai/gpt-4o', label: 'GPT-4o' },
                    { value: 'openai/gpt-4o-mini', label: 'GPT-4o Mini' },
                    { value: 'openai/gpt-4-turbo', label: 'GPT-4 Turbo' },
                    { value: 'openai/gpt-3.5-turbo', label: 'GPT-3.5 Turbo' },
                    { value: 'openai/gpt-4', label: 'GPT-4' }
                ],
                'deepseek': [
                    { value: 'deepseek/deepseek-chat', label: 'DeepSeek Chat' },
                    { value: 'deepseek/deepseek-coder', label: 'DeepSeek Coder' },
                    { value: 'deepseek/deepseek-chat:free', label: 'DeepSeek Chat (Free)' },
                    { value: 'deepseek/deepseek-coder:free', label: 'DeepSeek Coder (Free)' },
                    { value: 'deepseek/deepseek-chat:32k', label: 'DeepSeek Chat (32K)' }
                ]
            };
            
            // Get default model for provider
            const getDefaultModel = (provider) => {
                if (provider === 'openai') {
                    return 'openai/gpt-4o-mini';
                } else {
                    return 'deepseek/deepseek-chat';
                }
            };
            const [showConfig, setShowConfig] = useState(false);
            const [configLoading, setConfigLoading] = useState(false);
            const [apiResponse, setApiResponse] = useState(null);
            const [aiExplanation, setAiExplanation] = useState(null);

            useEffect(() => {
                console.log('App useEffect triggered');
                try {
                    fetchSuggestions();
                    fetchEndpoints();
                    fetchConfig();
                } catch (error) {
                    console.error('Error in useEffect:', error);
                }
            }, []);

            const fetchSuggestions = async () => {
                try {
                    const response = await axios.get('/api/suggestions');
                    setSuggestions(response.data.suggestions);
                } catch (err) {
                    console.error('Error fetching suggestions:', err);
                }
            };

            const fetchEndpoints = async () => {
                try {
                    const response = await axios.get('/api/endpoints');
                    setEndpoints(response.data);
                } catch (err) {
                    console.error('Error fetching endpoints:', err);
                }
            };

            // Validate and fix model based on provider
            const validateModelForProvider = (model, provider) => {
                if (!model || !provider) return getDefaultModel(provider || 'deepseek');
                
                // Check if model matches provider
                if (provider === 'openai') {
                    // If model doesn't start with 'openai/', it's invalid
                    if (!model.startsWith('openai/')) {
                        // Try to fix old format models (e.g., 'gpt-4o-mini' -> 'openai/gpt-4o-mini')
                        if (model.startsWith('gpt-')) {
                            return `openai/${model}`;
                        }
                        // Default to OpenAI model
                        return getDefaultModel('openai');
                    }
                } else if (provider === 'deepseek') {
                    // If model doesn't start with 'deepseek/', it's invalid
                    if (!model.startsWith('deepseek/')) {
                        // Default to DeepSeek model
                        return getDefaultModel('deepseek');
                    }
                }
                
                return model;
            };

            const fetchConfig = async () => {
                try {
                    const response = await axios.get('/api/config');
                    const loadedConfig = response.data;
                    
                    // Support backward compatibility: convert old openai_* keys to new openrouter_* keys
                    if (loadedConfig.openai_api_key && !loadedConfig.openrouter_api_key) {
                        loadedConfig.openrouter_api_key = loadedConfig.openai_api_key;
                    }
                    if (loadedConfig.openai_model && !loadedConfig.openrouter_model) {
                        loadedConfig.openrouter_model = loadedConfig.openai_model;
                    }
                    if (loadedConfig.openai_base_url && !loadedConfig.openrouter_base_url) {
                        loadedConfig.openrouter_base_url = loadedConfig.openai_base_url;
                    }
                    
                    // Validate and fix model if needed
                    const provider = loadedConfig.ai_provider || 'deepseek';
                    const model = validateModelForProvider(loadedConfig.openrouter_model || loadedConfig.openai_model, provider);
                    
                    // Update config with validated model
                    loadedConfig.openrouter_model = model;
                    
                    // Remove old keys if they exist
                    delete loadedConfig.openai_api_key;
                    delete loadedConfig.openai_model;
                    delete loadedConfig.openai_base_url;
                    
                    setConfig(loadedConfig);
                } catch (err) {
                    console.error('Error fetching config:', err);
                }
            };

            const updateConfig = async (e) => {
                e.preventDefault();
                setConfigLoading(true);
                
                try {
                    // Validate model before saving
                    const provider = config.ai_provider || 'deepseek';
                    const currentModel = config.openrouter_model || config.openai_model || getDefaultModel(provider);
                    const validatedModel = validateModelForProvider(currentModel, provider);
                    
                    // Prepare config with new parameter names
                    const configToSave = {
                        hostname: config.hostname,
                        api_token: config.api_token,
                        openrouter_api_key: config.openrouter_api_key || config.openai_api_key || '',
                        ai_provider: provider,
                        openrouter_model: validatedModel,
                        openrouter_base_url: config.openrouter_base_url || config.openai_base_url || 'https://openrouter.ai/api/v1'
                    };
                    
                    // If model was corrected, update the state
                    if (validatedModel !== currentModel) {
                        setConfig({...config, openrouter_model: validatedModel});
                        console.log(`Model corrected to '${validatedModel}' for provider '${provider}'`);
                    }
                    
                    const response = await axios.post('/api/config', configToSave);
                    const message = response.data.message;
                    const savedToFile = response.data.saved_to_file;
                    
                    if (savedToFile) {
                        alert('Configuration updated and saved permanently!');
                    } else {
                        alert('Configuration updated but failed to save to file. Changes will be lost on restart.');
                    }
                    setShowConfig(false);
                } catch (err) {
                    alert(err.response?.data?.error || 'Error updating configuration');
                } finally {
                    setConfigLoading(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!query.trim()) return;

                setLoading(true);
                setError('');
                setResult(null);

                try {
                    const response = await axios.post('/api/query', {
                        query: query.trim()
                    });
                    setResult(response.data);
                } catch (err) {
                    setError(err.response?.data?.error || 'An error occurred while processing your query');
                } finally {
                    setLoading(false);
                }
            };

            const handleSuggestionClick = (suggestion) => {
                setQuery(suggestion);
                // Auto-submit suggestion
                setTimeout(() => {
                    document.getElementById('query-form').dispatchEvent(new Event('submit'));
                }, 100);
            };

            const formatApiRequest = (apiRequest) => {
                const baseUrl = apiRequest.base_url || window.location.origin;
                const url = new URL(apiRequest.url, baseUrl);
                Object.entries(apiRequest.query_params || {}).forEach(([key, value]) => {
                    if (value !== null && value !== undefined) {
                        url.searchParams.append(key, value);
                    }
                });
                return {
                    ...apiRequest,
                    fullUrl: url.toString()
                };
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text);
                // You could add a toast notification here
            };

            const processResponseWithAI = async (responseData, apiRequest, detectedLanguage = 'en') => {
                try {
                    console.log('ü§ñ Processing response with AI...');
                    console.log('Response Data:', responseData);
                    console.log('API Request:', apiRequest);
                    console.log('Detected Language:', detectedLanguage);
                    
                    // Generate prompt based on detected language
                    let prompt;
                    const languagePrompts = {
                        'zh': {
                            intro: `‰Ω†ÊòØ‰∏ÄÂêçÁΩëÁªúÂÆâÂÖ®ÂàÜÊûêÂ∏àÔºåÊ≠£Âú®Ëß£ÈáäÂ®ÅËÉÅÊ£ÄÊµãÂíåÂìçÂ∫î(TDR)Êï∞ÊçÆ„ÄÇ

APIËØ∑Ê±Ç: ${apiRequest.method} ${apiRequest.url}
Êü•ËØ¢ÂèÇÊï∞: ${JSON.stringify(apiRequest.query_params || {})}

APIÂìçÂ∫îÊï∞ÊçÆ:
${JSON.stringify(responseData, null, 2)}

ËØ∑Êèê‰æõÊ∏ÖÊô∞„ÄÅËá™ÁÑ∂ËØ≠Ë®ÄÁöÑÂÆâÂÖ®Â®ÅËÉÅÊï∞ÊçÆËß£Èáä„ÄÇÈáçÁÇπÂÖ≥Ê≥®Ôºö`,
                            sections: `1. **ÊëòË¶Å**: Ëøô‰∫õÊï∞ÊçÆÂëäËØâÊàë‰ª¨‰ªÄ‰πàÂÆâÂÖ®Â®ÅËÉÅ‰ø°ÊÅØÔºü
2. **ÂÖ≥ÈîÆÂèëÁé∞**: ÊúÄÈáçË¶ÅÁöÑÂÆâÂÖ®Ê¥ûÂØüÊòØ‰ªÄ‰πàÔºü
3. **È£éÈô©ËØÑ‰º∞**: Ëøô‰∫õÂ®ÅËÉÅÁöÑ‰∏•ÈáçÁ®ãÂ∫¶Â¶Ç‰ΩïÔºü
4. **Âª∫ËÆÆ**: Â∫îËØ•ÈááÂèñ‰ªÄ‰πàË°åÂä®Ôºü`,
                            format: `ËØ∑‰ª•‰∏ì‰∏öÂÆâÂÖ®Êä•ÂëäÁöÑÂΩ¢ÂºèÂõûÁ≠î„ÄÇÂÖ∑‰ΩìËØ¥ÊòéÊï∞Â≠ó„ÄÅÊó•ÊúüÂíåÈ£éÈô©Á∫ßÂà´„ÄÇ‰ΩøÁî®Ê∏ÖÊô∞„ÄÅÈùûÊäÄÊúØÊÄßËØ≠Ë®ÄÔºåËÆ©ÂÆâÂÖ®ÁÆ°ÁêÜ‰∫∫ÂëòËÉΩÂ§üÁêÜËß£„ÄÇ`,
                            userData: `Â¶ÇÊûúÂìçÂ∫îÂåÖÂê´Áî®Êà∑Â®ÅËÉÅÊï∞ÊçÆÔºåËØ∑Ëß£ÈáäÔºö
- Âì™‰∫õÁî®Êà∑Èù¢‰∏¥ÊúÄÂ§ßÈ£éÈô©
- ‰ªÄ‰πàË°å‰∏∫Ëß¶Âèë‰∫ÜË≠¶Êä•
- È£éÈô©ËØÑÂàÜÁöÑÂê´‰πâ`,
                            deviceData: `Â¶ÇÊûúÂìçÂ∫îÂåÖÂê´ËÆæÂ§áÂ®ÅËÉÅÊï∞ÊçÆÔºåËØ∑Ëß£ÈáäÔºö
- Âì™‰∫õËÆæÂ§áË¢´ÂÖ•‰æµÊàñÂèØÁñë
- Ê£ÄÊµãÂà∞‰ªÄ‰πàÊ¥ªÂä®
- ÁΩëÁªúÂÆâÂÖ®ÂΩ±Âìç`,
                            processData: `Â¶ÇÊûúÂìçÂ∫îÂåÖÂê´ËøõÁ®ãÊï∞ÊçÆÔºåËØ∑Ëß£ÈáäÔºö
- ÊâßË°å‰∫Ü‰ªÄ‰πàÂºÇÂ∏∏ËøõÁ®ã
- ‰∏∫‰ªÄ‰πàÂÆÉ‰ª¨Ë¢´ËÆ§‰∏∫ÊòØÂèØÁñëÁöÑ
- ÊΩúÂú®ÁöÑÊîªÂáªÂêëÈáè`,
                            conclusion: `‰øùÊåÅËß£ÈáäÁÆÄÊ¥Å‰ΩÜÂÖ®Èù¢„ÄÇ`
                        },
                        'zh-tw': {
                            intro: `ÊÇ®ÊòØ‰∏ÄÂêçÁ∂≤Ë∑ØÂÆâÂÖ®ÂàÜÊûêÂ∏´ÔºåÊ≠£Âú®Ëß£ÈáãÂ®ÅËÑÖÂÅµÊ∏¨ÂíåÂõûÊáâ(TDR)Ë≥áÊñô„ÄÇ

APIË´ãÊ±Ç: ${apiRequest.method} ${apiRequest.url}
Êü•Ë©¢ÂèÉÊï∏: ${JSON.stringify(apiRequest.query_params || {})}

APIÂõûÊáâË≥áÊñô:
${JSON.stringify(responseData, null, 2)}

Ë´ãÊèê‰æõÊ∏ÖÊô∞„ÄÅËá™ÁÑ∂Ë™ûË®ÄÁöÑÂÆâÂÖ®Â®ÅËÑÖË≥áÊñôËß£Èáã„ÄÇÈáçÈªûÈóúÊ≥®Ôºö`,
                            sections: `1. **ÊëòË¶Å**: ÈÄô‰∫õË≥áÊñôÂëäË®¥ÊàëÂÄë‰ªÄÈ∫ºÂÆâÂÖ®Â®ÅËÑÖË≥áË®äÔºü
2. **ÈóúÈçµÁôºÁèæ**: ÊúÄÈáçË¶ÅÁöÑÂÆâÂÖ®Ê¥ûÂØüÊòØ‰ªÄÈ∫ºÔºü
3. **È¢®Èö™Ë©ï‰º∞**: ÈÄô‰∫õÂ®ÅËÑÖÁöÑÂö¥ÈáçÁ®ãÂ∫¶Â¶Ç‰ΩïÔºü
4. **Âª∫Ë≠∞**: ÊáâË©≤Êé°Âèñ‰ªÄÈ∫ºË°åÂãïÔºü`,
                            format: `Ë´ã‰ª•Â∞àÊ•≠ÂÆâÂÖ®Â†±ÂëäÁöÑÂΩ¢ÂºèÂõûÁ≠î„ÄÇÂÖ∑È´îË™™ÊòéÊï∏Â≠ó„ÄÅÊó•ÊúüÂíåÈ¢®Èö™Á¥öÂà•„ÄÇ‰ΩøÁî®Ê∏ÖÊô∞„ÄÅÈùûÊäÄË°ìÊÄßË™ûË®ÄÔºåËÆìÂÆâÂÖ®ÁÆ°ÁêÜ‰∫∫Âì°ËÉΩÂ§†ÁêÜËß£„ÄÇ`,
                            userData: `Â¶ÇÊûúÂõûÊáâÂåÖÂê´‰ΩøÁî®ËÄÖÂ®ÅËÑÖË≥áÊñôÔºåË´ãËß£ÈáãÔºö
- Âì™‰∫õ‰ΩøÁî®ËÄÖÈù¢Ëá®ÊúÄÂ§ßÈ¢®Èö™
- ‰ªÄÈ∫ºË°åÁÇ∫Ëß∏Áôº‰∫ÜË≠¶Â†±
- È¢®Èö™Ë©ïÂàÜÁöÑÂê´Áæ©`,
                            deviceData: `Â¶ÇÊûúÂõûÊáâÂåÖÂê´Ë£ùÁΩÆÂ®ÅËÑÖË≥áÊñôÔºåË´ãËß£ÈáãÔºö
- Âì™‰∫õË£ùÁΩÆË¢´ÂÖ•‰æµÊàñÂèØÁñë
- ÂÅµÊ∏¨Âà∞‰ªÄÈ∫ºÊ¥ªÂãï
- Á∂≤Ë∑ØÂÆâÂÖ®ÂΩ±Èüø`,
                            processData: `Â¶ÇÊûúÂõûÊáâÂåÖÂê´Á®ãÂ∫èË≥áÊñôÔºåË´ãËß£ÈáãÔºö
- Âü∑Ë°å‰∫Ü‰ªÄÈ∫ºÁï∞Â∏∏Á®ãÂ∫è
- ÁÇ∫‰ªÄÈ∫ºÂÆÉÂÄëË¢´Ë™çÁÇ∫ÊòØÂèØÁñëÁöÑ
- ÊΩõÂú®ÁöÑÊîªÊìäÂêëÈáè`,
                            conclusion: `‰øùÊåÅËß£ÈáãÁ∞°ÊΩî‰ΩÜÂÖ®Èù¢„ÄÇ`
                        },
                        'ja': {
                            intro: `„ÅÇ„Å™„Åü„ÅØËÑÖÂ®ÅÊ§úÂá∫„Åä„Çà„Å≥ÂØæÂøúÔºàTDRÔºâ„Éá„Éº„Çø„ÇíË™¨Êòé„Åô„ÇãÂ∞ÇÈñÄ„ÅÆ„Çµ„Ç§„Éê„Éº„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç¢„Éä„É™„Çπ„Éà„Åß„Åô„ÄÇ

API„É™„ÇØ„Ç®„Çπ„Éà: ${apiRequest.method} ${apiRequest.url}
„ÇØ„Ç®„É™„Éë„É©„É°„Éº„Çø: ${JSON.stringify(apiRequest.query_params || {})}

API„É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø:
${JSON.stringify(responseData, null, 2)}

„Åì„ÅÆËÑÖÂ®ÅÊ§úÂá∫„Éá„Éº„Çø„ÅÆÊòéÁ¢∫„ÅßËá™ÁÑ∂„Å™Ë®ÄË™û„Åß„ÅÆË™¨Êòé„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•‰∏ã„ÅÆÁÇπ„Å´ÁÑ¶ÁÇπ„ÇíÂΩì„Å¶„Å¶„Åè„Å†„Åï„ÅÑÔºö`,
                            sections: `1. **Ë¶ÅÁ¥Ñ**: „Åì„ÅÆ„Éá„Éº„Çø„ÅØ„Å©„ÅÆ„Çà„ÅÜ„Å™„Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÑÖÂ®Å„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶„Åè„Çå„Åæ„Åô„ÅãÔºü
2. **‰∏ªË¶Å„Å™Áô∫Ë¶ã**: ÊúÄ„ÇÇÈáçË¶Å„Å™„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ê¥ûÂØü„ÅØ‰Ωï„Åß„Åô„ÅãÔºü
3. **„É™„Çπ„ÇØË©ï‰æ°**: „Åì„Çå„Çâ„ÅÆËÑÖÂ®Å„ÅÆÊ∑±ÂàªÂ∫¶„ÅØ„Å©„ÅÆÁ®ãÂ∫¶„Åß„Åô„ÅãÔºü
4. **Êé®Â•®‰∫ãÈ†Ö**: „Å©„ÅÆ„Çà„ÅÜ„Å™Ë°åÂãï„ÇíÂèñ„Çã„Åπ„Åç„Åß„Åô„ÅãÔºü`,
                            format: `Â∞ÇÈñÄÁöÑ„Å™„Çª„Ç≠„É•„É™„ÉÜ„Ç£„É¨„Éù„Éº„Éà„ÅÆÂΩ¢Âºè„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊï∞Â≠ó„ÄÅÊó•‰ªò„ÄÅ„É™„Çπ„ÇØ„É¨„Éô„É´„ÇíÂÖ∑‰ΩìÁöÑ„Å´Ë™¨Êòé„Åó„ÄÅ„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÁÆ°ÁêÜËÄÖ„ÅåÁêÜËß£„Åß„Åç„Çã„Çà„ÅÜ„ÄÅÊòéÁ¢∫„ÅßÈùûÊäÄË°ìÁöÑ„Å™Ë®ÄË™û„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                            userData: `„É¨„Çπ„Éù„É≥„Çπ„Å´„É¶„Éº„Ç∂„ÉºËÑÖÂ®Å„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ‰ª•‰∏ã„ÇíË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
- „Å©„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåÊúÄ„ÇÇ„É™„Çπ„ÇØ„Å´„Åï„Çâ„Åï„Çå„Å¶„ÅÑ„Çã„Åã
- „Å©„ÅÆË°åÂãï„Åå„Ç¢„É©„Éº„Éà„ÇíÂºï„ÅçËµ∑„Åì„Åó„Åü„Åã
- „É™„Çπ„ÇØ„Çπ„Ç≥„Ç¢„ÅÆÊÑèÂë≥`,
                            deviceData: `„É¨„Çπ„Éù„É≥„Çπ„Å´„Éá„Éê„Ç§„ÇπËÑÖÂ®Å„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ‰ª•‰∏ã„ÇíË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
- „Å©„ÅÆ„Éá„Éê„Ç§„Çπ„Åå‰æµÂÆ≥„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅ„Åæ„Åü„ÅØÁñë„Çè„Åó„ÅÑ„Åã
- „Å©„ÅÆ„Çà„ÅÜ„Å™Ê¥ªÂãï„ÅåÊ§úÂá∫„Åï„Çå„Åü„Åã
- „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Å∏„ÅÆÂΩ±Èüø`,
                            processData: `„É¨„Çπ„Éù„É≥„Çπ„Å´„Éó„É≠„Çª„Çπ„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ‰ª•‰∏ã„ÇíË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
- „Å©„ÅÆ„Çà„ÅÜ„Å™Áï∞Â∏∏„Å™„Éó„É≠„Çª„Çπ„ÅåÂÆüË°å„Åï„Çå„Åü„Åã
- „Å™„Åú„Åù„Çå„Çâ„ÅåÁñë„Çè„Åó„ÅÑ„Å®ËÄÉ„Åà„Çâ„Çå„Çã„Åã
- ÊΩúÂú®ÁöÑ„Å™ÊîªÊíÉ„Éô„ÇØ„Éà„É´`,
                            conclusion: `Ë™¨Êòé„ÅØÁ∞°ÊΩî„Åß„ÅÇ„Çä„Å™„Åå„ÇâÂåÖÊã¨ÁöÑ„Åß„ÅÇ„Çã„Åì„Å®„ÇíÂøÉ„Åå„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
                        },
                        'ko': {
                            intro: `ÎãπÏã†ÏùÄ ÏúÑÌòë ÌÉêÏßÄ Î∞è ÎåÄÏùë(TDR) Îç∞Ïù¥ÌÑ∞Î•º ÏÑ§Î™ÖÌïòÎäî Ï†ÑÎ¨∏ ÏÇ¨Ïù¥Î≤ÑÎ≥¥Ïïà Î∂ÑÏÑùÍ∞ÄÏûÖÎãàÎã§.

API ÏöîÏ≤≠: ${apiRequest.method} ${apiRequest.url}
ÏøºÎ¶¨ Îß§Í∞úÎ≥ÄÏàò: ${JSON.stringify(apiRequest.query_params || {})}

API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:
${JSON.stringify(responseData, null, 2)}

Ïù¥ ÏúÑÌòë ÌÉêÏßÄ Îç∞Ïù¥ÌÑ∞Ïóê ÎåÄÌïú Î™ÖÌôïÌïòÍ≥† ÏûêÏó∞Ïä§Îü¨Ïö¥ Ïñ∏Ïñ¥ ÏÑ§Î™ÖÏùÑ Ï†úÍ≥µÌï¥ Ï£ºÏÑ∏Ïöî. Îã§ÏùåÏóê Ï§ëÏ†êÏùÑ ÎëêÏÑ∏Ïöî:`,
                            sections: `1. **ÏöîÏïΩ**: Ïù¥ Îç∞Ïù¥ÌÑ∞Îäî Ïñ¥Îñ§ Î≥¥Ïïà ÏúÑÌòëÏóê ÎåÄÌï¥ ÏïåÎ†§Ï£ºÎÇòÏöî?
2. **Ï£ºÏöî Î∞úÍ≤¨**: Í∞ÄÏû• Ï§ëÏöîÌïú Î≥¥Ïïà Ïù∏ÏÇ¨Ïù¥Ìä∏Îäî Î¨¥ÏóáÏù∏Í∞ÄÏöî?
3. **ÏúÑÌóò ÌèâÍ∞Ä**: Ïù¥Îü¨Ìïú ÏúÑÌòëÏùò Ïã¨Í∞ÅÎèÑÎäî Ïñ¥Îäê Ï†ïÎèÑÏù∏Í∞ÄÏöî?
4. **Í∂åÏû•ÏÇ¨Ìï≠**: Ïñ¥Îñ§ Ï°∞ÏπòÎ•º Ï∑®Ìï¥Ïïº ÌïòÎÇòÏöî?`,
                            format: `Ï†ÑÎ¨∏Ï†ÅÏù∏ Î≥¥Ïïà Î≥¥Í≥†ÏÑú ÌòïÏãùÏúºÎ°ú ÎãµÎ≥ÄÌï¥ Ï£ºÏÑ∏Ïöî. Ïà´Ïûê, ÎÇ†Ïßú, ÏúÑÌóò ÏàòÏ§ÄÏùÑ Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÏÑ§Î™ÖÌïòÍ≥†, Î≥¥Ïïà Í¥ÄÎ¶¨ÏûêÍ∞Ä Ïù¥Ìï¥Ìï† Ïàò ÏûàÎèÑÎ°ù Î™ÖÌôïÌïòÍ≥† ÎπÑÍ∏∞Ïà†Ï†ÅÏù∏ Ïñ∏Ïñ¥Î•º ÏÇ¨Ïö©Ìï¥ Ï£ºÏÑ∏Ïöî.`,
                            userData: `ÏùëÎãµÏóê ÏÇ¨Ïö©Ïûê ÏúÑÌòë Îç∞Ïù¥ÌÑ∞Í∞Ä Ìè¨Ìï®Îêú Í≤ΩÏö∞ Îã§ÏùåÏùÑ ÏÑ§Î™ÖÌï¥ Ï£ºÏÑ∏Ïöî:
- Ïñ¥Îñ§ ÏÇ¨Ïö©ÏûêÍ∞Ä Í∞ÄÏû• ÏúÑÌóòÏóê ÎÖ∏Ï∂úÎêòÏñ¥ ÏûàÎäîÏßÄ
- Ïñ¥Îñ§ ÌñâÎèôÏù¥ Í≤ΩÍ≥†Î•º Ìä∏Î¶¨Í±∞ÌñàÎäîÏßÄ
- ÏúÑÌóò Ï†êÏàòÏùò ÏùòÎØ∏`,
                            deviceData: `ÏùëÎãµÏóê ÎîîÎ∞îÏù¥Ïä§ ÏúÑÌòë Îç∞Ïù¥ÌÑ∞Í∞Ä Ìè¨Ìï®Îêú Í≤ΩÏö∞ Îã§ÏùåÏùÑ ÏÑ§Î™ÖÌï¥ Ï£ºÏÑ∏Ïöî:
- Ïñ¥Îñ§ ÎîîÎ∞îÏù¥Ïä§Í∞Ä ÏÜêÏÉÅÎêòÏóàÍ±∞ÎÇò ÏùòÏã¨Ïä§Îü¨Ïö¥ÏßÄ
- Ïñ¥Îñ§ ÌôúÎèôÏù¥ ÌÉêÏßÄÎêòÏóàÎäîÏßÄ
- ÎÑ§Ìä∏ÏõåÌÅ¨ Î≥¥ÏïàÏóê ÎØ∏ÏπòÎäî ÏòÅÌñ•`,
                            processData: `ÏùëÎãµÏóê ÌîÑÎ°úÏÑ∏Ïä§ Îç∞Ïù¥ÌÑ∞Í∞Ä Ìè¨Ìï®Îêú Í≤ΩÏö∞ Îã§ÏùåÏùÑ ÏÑ§Î™ÖÌï¥ Ï£ºÏÑ∏Ïöî:
- Ïñ¥Îñ§ ÎπÑÏ†ïÏÉÅÏ†ÅÏù∏ ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä Ïã§ÌñâÎêòÏóàÎäîÏßÄ
- Ïôú Í∑∏Í≤ÉÎì§Ïù¥ ÏùòÏã¨Ïä§ÎüΩÎã§Í≥† Ïó¨Í≤®ÏßÄÎäîÏßÄ
- Ïû†Ïû¨Ï†ÅÏù∏ Í≥µÍ≤© Î≤°ÌÑ∞`,
                            conclusion: `ÏÑ§Î™ÖÏùÄ Í∞ÑÍ≤∞ÌïòÎ©¥ÏÑúÎèÑ Ìè¨Í¥ÑÏ†ÅÏúºÎ°ú ÏûëÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî.`
                        }
                    };
                    
                    const langData = languagePrompts[detectedLanguage];
                    if (langData) {
                        prompt = `${langData.intro}

${langData.sections}

${langData.format}

${langData.userData}

${langData.deviceData}

${langData.processData}

${langData.conclusion}`;
                    } else {
                        // Default English prompt
                        prompt = `You are a cybersecurity analyst explaining threat detection and response (TDR) data. 
                        
API Request: ${apiRequest.method} ${apiRequest.url}
Query Parameters: ${JSON.stringify(apiRequest.query_params || {})}

API Response Data:
${JSON.stringify(responseData, null, 2)}

Please provide a clear, natural language explanation of this threat detection data. Focus on:

1. **Summary**: What does this data tell us about security threats?
2. **Key Findings**: What are the most important security insights?
3. **Risk Assessment**: How serious are these threats?
4. **Recommendations**: What actions should be taken?

Format your response as a professional security report. Be specific about numbers, dates, and risk levels. Use clear, non-technical language that a security manager could understand.

If the response contains user threat data, explain:
- Which users are most at risk
- What behaviors triggered the alerts
- Risk scores and their meaning

If the response contains device threat data, explain:
- Which devices are compromised or suspicious
- What activities were detected
- Network security implications

If the response contains process data, explain:
- What unusual processes were executed
- Why they're considered suspicious
- Potential attack vectors

Keep the explanation concise but comprehensive.`;
                    }

                    console.log('üì§ Sending request to /api/ai-explain...');
                    const response = await fetch('/api/ai-explain', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            responseData: responseData,
                            apiRequest: apiRequest,
                            detected_language: detectedLanguage
                        })
                    });

                    console.log('üì• Received response from AI endpoint:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå AI endpoint error:', response.status, errorText);
                        throw new Error(`AI processing failed: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('üìã AI endpoint result:', result);
                    
                    return result.explanation || result.error || 'AI explanation not available';
                    
                } catch (error) {
                    console.error('‚ùå AI processing error:', error);
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    throw error;
                }
            };

            const sendApiRequest = async (apiRequest) => {
                try {
                    console.log('=== API REQUEST DEBUG ===');
                    console.log('Original API request object:', apiRequest);
                    
                    // Check if we should use proxy (for CORS issues)
                    const useProxy = true; // Always use proxy to avoid CORS issues
                    
                    if (useProxy) {
                        console.log('Using proxy to avoid CORS issues...');
                        
                        // Build proxy URL
                        const proxyUrl = `/api/proxy${apiRequest.url}`;
                        const url = new URL(proxyUrl, window.location.origin);
                        
                        // Add query parameters
                        console.log('Query parameters:', apiRequest.query_params);
                        Object.entries(apiRequest.query_params || {}).forEach(([key, value]) => {
                            if (value !== null && value !== undefined) {
                                url.searchParams.append(key, value);
                                console.log(`Added query param: ${key} = ${value}`);
                            }
                        });
                        
                        const requestOptions = {
                            method: apiRequest.method,
                            headers: {
                                'Accept': 'application/json'
                            }
                        };
                        
                        console.log('Proxy URL:', url.toString());
                        console.log('Request options:', requestOptions);
                        
                        // Show loading indicator
                        const loadingModal = showLoadingModal();
                        
                        const response = await fetch(url.toString(), requestOptions);
                        const responseData = await response.text();
                        
                        // Remove loading indicator
                        loadingModal.remove();
                        
                        let parsedData;
                        try {
                            parsedData = JSON.parse(responseData);
                        } catch {
                            parsedData = responseData;
                        }
                        
                        // Process response with AI if successful
                        console.log('üîç Checking response status...');
                        console.log('Response OK:', response.ok);
                        console.log('Response Status:', response.status);
                        console.log('Parsed Data:', parsedData);
                        
                        if (response.ok && parsedData) {
                            console.log('‚úÖ API Request Successful');
                            console.log('Response Status:', response.status, response.statusText);
                            console.log('Response Headers:', Object.fromEntries(response.headers.entries()));
                            console.log('Response Data:', parsedData);
                            
                            // Update API response state
                            setApiResponse({
                                status: response.status,
                                statusText: response.statusText,
                                headers: Object.fromEntries(response.headers.entries()),
                                data: parsedData,
                                url: url.toString(),
                                method: 'proxy'
                            });
                            
                            console.log('ü§ñ Starting AI processing...');
                            console.log('‚è∞ Waiting for async operations to complete...');
                            // Give async operations time to complete
                            await new Promise(resolve => setTimeout(resolve, 200));
                            console.log('‚úÖ Async wait complete, starting AI processing...');
                            try {
                                console.log('üì§ Calling processResponseWithAI...');
                                // Get detected language from the result (if available)
                                const detectedLanguage = result?.detected_language || 'en';
                                console.log('üåç Detected language for AI explanation:', detectedLanguage);
                                console.log('üìã Full result object:', result);
                                const aiExplanation = await processResponseWithAI(parsedData, apiRequest, detectedLanguage);
                                console.log('‚úÖ AI Processing Successful');
                                console.log('AI Explanation received:', aiExplanation);
                                console.log('AI Explanation type:', typeof aiExplanation);
                                console.log('AI Explanation length:', aiExplanation ? aiExplanation.length : 'null');
                                
                                setAiExplanation(aiExplanation);
                                console.log('‚úÖ AI explanation state updated');
                                
                                // Show AI explanation in popup
                                console.log('üé≠ Showing AI explanation modal...');
                                const modalData = {
                                    status: response.status,
                                    statusText: response.statusText,
                                    data: parsedData,
                                    aiExplanation: aiExplanation,
                                    url: url.toString(),
                                    method: 'proxy'
                                };
                                console.log('Modal data:', modalData);
                                showAiExplanationModal(modalData);
                                console.log('‚úÖ AI explanation modal called');
                            } catch (aiError) {
                                console.error('‚ùå AI Processing Failed:', aiError);
                                console.error('AI Error Details:', aiError.message);
                                console.error('AI Error Stack:', aiError.stack);
                                setAiExplanation(null);
                                
                                // Show error popup
                                console.log('üé≠ Showing AI error modal...');
                                const errorModalData = {
                                    status: response.status,
                                    statusText: response.statusText,
                                    data: parsedData,
                                    url: url.toString(),
                                    method: 'proxy',
                                    aiError: aiError.message
                                };
                                console.log('Error modal data:', errorModalData);
                                showAiExplanationModal(errorModalData);
                                console.log('‚úÖ AI error modal called');
                            }
                        } else {
                            console.log('‚ùå API Request Failed');
                            console.log('Response Status:', response.status, response.statusText);
                            console.log('Response Data:', parsedData);
                            
                            // Update API response state with error
                            setApiResponse({
                                status: response.status,
                                statusText: response.statusText,
                                headers: Object.fromEntries(response.headers.entries()),
                                data: parsedData,
                                url: url.toString(),
                                method: 'proxy',
                                error: true
                            });
                            setAiExplanation(null);
                        }
                        
                    } else {
                        // Original direct request code (kept for reference)
                        const baseUrl = apiRequest.base_url || window.location.origin;
                        console.log('Base URL:', baseUrl);
                        console.log('API path:', apiRequest.url);
                        
                        const url = new URL(apiRequest.url, baseUrl);
                        console.log('Initial URL:', url.toString());
                        
                        // Add query parameters
                        console.log('Query parameters:', apiRequest.query_params);
                        Object.entries(apiRequest.query_params || {}).forEach(([key, value]) => {
                            if (value !== null && value !== undefined) {
                                url.searchParams.append(key, value);
                                console.log(`Added query param: ${key} = ${value}`);
                            }
                        });
                        
                        const requestOptions = {
                            method: apiRequest.method,
                            headers: apiRequest.headers || {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            mode: 'cors', // Enable CORS
                            credentials: 'omit' // Don't send cookies
                        };
                        
                        // For CORS issues, try different approaches
                        if (apiRequest.method === 'GET') {
                            // For GET requests, try no-cors mode as fallback
                            console.log('Trying CORS mode first...');
                        } else {
                            // For non-GET requests, we need CORS to work
                            console.log('Non-GET request requires CORS support');
                        }
                        
                        // Add body for POST/PUT requests
                        if (['POST', 'PUT', 'PATCH'].includes(apiRequest.method)) {
                            requestOptions.body = JSON.stringify(apiRequest.body || {});
                            console.log('Request body:', requestOptions.body);
                        }
                        
                        console.log('Final constructed URL:', url.toString());
                        console.log('Final request options:', requestOptions);
                        console.log('Headers being sent:', requestOptions.headers);
                        console.log('=== END API REQUEST DEBUG ===');
                        
                        // Show loading indicator
                        const loadingModal = showLoadingModal();
                        
                        const response = await fetch(url.toString(), requestOptions);
                        const responseData = await response.text();
                        
                        // Remove loading indicator
                        loadingModal.remove();
                        
                        let parsedData;
                        try {
                            parsedData = JSON.parse(responseData);
                        } catch {
                            parsedData = responseData;
                        }
                        
                        // Show response in a modal
                        showApiResponse({
                            status: response.status,
                            statusText: response.statusText,
                            headers: Object.fromEntries(response.headers.entries()),
                            data: parsedData,
                            url: url.toString(),
                            method: 'direct'
                        });
                    }
                    
                } catch (error) {
                    console.error('API request failed:', error);
                    
                    // Show detailed error information
                    showApiError({
                        error: error.message,
                        type: error.name,
                        url: apiRequest.base_url + apiRequest.url,
                        suggestions: getErrorSuggestions(error)
                    });
                }
            };

            const showLoadingModal = () => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="glass-effect rounded-2xl p-6 text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <h3 class="text-xl font-semibold text-white mb-2">Sending API Request</h3>
                        <p class="text-blue-200">Please wait...</p>
                    </div>
                `;
                document.body.appendChild(modal);
                return modal;
            };

            const getErrorSuggestions = (error) => {
                const suggestions = [];
                
                if (error.message.includes('Failed to fetch')) {
                    suggestions.push('Check if the API server is running and accessible');
                    suggestions.push('Verify the hostname and port in your configuration');
                    suggestions.push('Check if there are any firewall or network restrictions');
                    suggestions.push('Try accessing the API URL directly in your browser');
                }
                
                if (error.message.includes('CORS')) {
                    suggestions.push('The API server may not allow cross-origin requests');
                    suggestions.push('Contact your API administrator about CORS configuration');
                }
                
                if (error.message.includes('SSL') || error.message.includes('certificate')) {
                    suggestions.push('There may be an SSL certificate issue');
                    suggestions.push('Try using HTTP instead of HTTPS if in a development environment');
                }
                
                return suggestions;
            };

            const showApiError = (errorInfo) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2';
                modal.innerHTML = `
                    <div class="glass-effect rounded-2xl p-4 w-full max-w-2xl h-[80vh] flex flex-col">
                        <div class="flex justify-between items-center mb-3 flex-shrink-0">
                            <h3 class="text-lg font-semibold text-white">
                                <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
                                API Request Failed
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-red-300 transition-colors text-xl p-1">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto space-y-3 pr-2">
                            <div class="bg-red-500/20 rounded-lg p-3 border border-red-500/30">
                                <h4 class="text-white font-medium mb-2">Error Details</h4>
                                <p class="text-red-200 mb-2 text-sm"><strong>Type:</strong> ${errorInfo.type}</p>
                                <p class="text-red-200 mb-2 text-sm"><strong>Message:</strong> ${errorInfo.error}</p>
                                <p class="text-red-200 text-sm"><strong>URL:</strong> <code class="text-red-300 text-xs break-all">${errorInfo.url}</code></p>
                            </div>
                            
                            <div class="bg-blue-500/20 rounded-lg p-3 border border-blue-500/30">
                                <h4 class="text-white font-medium mb-2">Troubleshooting Suggestions</h4>
                                <ul class="text-blue-200 space-y-1 text-sm">
                                    ${errorInfo.suggestions.map(suggestion => `<li>‚Ä¢ ${suggestion}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="bg-yellow-500/20 rounded-lg p-3 border border-yellow-500/30">
                                <h4 class="text-white font-medium mb-2">Quick Tests</h4>
                                <div class="space-y-2">
                                    <button onclick="testApiConnectivity('${errorInfo.url}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                                        Test API Connectivity
                                    </button>
                                    <button onclick="openApiUrl('${errorInfo.url}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors ml-2">
                                        Open in Browser
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add keyboard support for closing
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                
                // Focus the close button for accessibility
                setTimeout(() => {
                    const closeBtn = modal.querySelector('button');
                    if (closeBtn) closeBtn.focus();
                }, 100);
            };

            // Helper functions for error modal
            window.testApiConnectivity = async (url) => {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    alert(`API is reachable! Status: ${response.status}`);
                } catch (error) {
                    alert(`API connectivity test failed: ${error.message}`);
                }
            };

            window.openApiUrl = (url) => {
                window.open(url, '_blank');
            };

            const showAiExplanationModal = (response) => {
                console.log('üé≠ showAiExplanationModal called with:', response);
                console.log('Response keys:', Object.keys(response));
                console.log('Has AI explanation:', response.aiExplanation);
                console.log('Has AI error:', response.aiError);
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2';
                
                // Determine if we have AI explanation
                const hasAIExplanation = response.aiExplanation && !response.aiError;
                const hasAIError = response.aiError;
                
                console.log('Modal conditions - hasAIExplanation:', hasAIExplanation, 'hasAIError:', hasAIError);
                
                 modal.innerHTML = `
                     <div class="glass-effect rounded-2xl p-4 w-full max-w-4xl h-[85vh] flex flex-col">
                         <div class="flex justify-between items-center mb-3 flex-shrink-0">
                             <h3 class="text-lg font-semibold text-white">
                                 <i class="fas fa-robot mr-2"></i>
                                 AI Security Analysis
                                 ${hasAIExplanation ? '<span class="ml-2 text-green-300 text-sm">‚úÖ Success</span>' : ''}
                                 ${hasAIError ? '<span class="ml-2 text-yellow-300 text-sm">‚ö†Ô∏è Failed</span>' : ''}
                             </h3>
                             <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-red-300 transition-colors text-xl p-1">
                                 <i class="fas fa-times"></i>
                             </button>
                         </div>
                         
                         <div class="flex-1 overflow-y-auto space-y-3 pr-2" style="max-height: calc(85vh - 120px);">
                             ${hasAIExplanation ? `
                                 <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-lg p-3 border border-blue-400/30">
                                     <h4 class="text-white font-medium mb-2 flex items-center">
                                         <i class="fas fa-shield-alt mr-2 text-blue-300"></i>
                                         Security Analysis Report
                                     </h4>
                                     <div class="text-white text-sm leading-relaxed whitespace-pre-wrap max-h-96 overflow-y-auto bg-black/20 p-3 rounded border">${response.aiExplanation}</div>
                                 </div>
                             ` : ''}
                             
                             ${hasAIError ? `
                                 <div class="bg-yellow-500/20 rounded-lg p-3 border border-yellow-400/30">
                                     <h4 class="text-yellow-200 font-medium mb-2">‚ö†Ô∏è AI Processing Failed</h4>
                                     <p class="text-yellow-100 text-sm">${response.aiError}</p>
                                     <p class="text-yellow-200 text-xs mt-2">The API request was successful, but AI analysis failed. Check the console for details.</p>
                                 </div>
                             ` : ''}
                             
                             <div class="bg-white/10 rounded-lg p-3">
                                 <h4 class="text-white font-medium mb-2">Request Information</h4>
                                 <p class="text-blue-200 text-sm"><strong>URL:</strong> <code class="text-green-300 text-xs break-all">${response.url}</code></p>
                                 <p class="text-blue-200 text-sm"><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${response.status < 400 ? 'bg-green-600' : 'bg-red-600'} text-white">${response.status} ${response.statusText}</span></p>
                                 ${response.method === 'proxy' ? '<p class="text-blue-200 text-xs mt-1">‚úÖ Request sent via proxy (CORS bypassed)</p>' : ''}
                             </div>
                         </div>
                     </div>
                 `;
                
                console.log('üé≠ Modal HTML created, appending to document...');
                document.body.appendChild(modal);
                console.log('‚úÖ Modal appended to document body');
                
                // Add keyboard support for closing
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        console.log('üé≠ Modal closed via ESC key');
                        modal.remove();
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                
                // Focus the close button for accessibility
                setTimeout(() => {
                    const closeBtn = modal.querySelector('button');
                    if (closeBtn) {
                        closeBtn.focus();
                        console.log('‚úÖ Modal close button focused');
                    }
                }, 100);
                
                console.log('üé≠ Modal setup complete');
            };

            const showApiResponse = (response) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2';
                
                // Determine if we have AI explanation
                const hasAIExplanation = response.aiExplanation && !response.aiError;
                const hasAIError = response.aiError;
                
                 modal.innerHTML = `
                     <div class="glass-effect rounded-2xl p-4 w-full max-w-5xl h-[85vh] flex flex-col">
                         <div class="flex justify-between items-center mb-3 flex-shrink-0">
                             <h3 class="text-lg font-semibold text-white">
                                 <i class="fas fa-server mr-2"></i>
                                 API Response
                                 ${hasAIExplanation ? '<span class="ml-2 text-green-300 text-sm">ü§ñ AI Analyzed</span>' : ''}
                                 ${hasAIError ? '<span class="ml-2 text-yellow-300 text-sm">‚ö†Ô∏è AI Failed</span>' : ''}
                             </h3>
                             <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-red-300 transition-colors text-xl p-1">
                                 <i class="fas fa-times"></i>
                             </button>
                         </div>
                         
                         <div class="flex-1 overflow-y-auto space-y-3 pr-2" style="max-height: calc(85vh - 120px);">
                             ${hasAIExplanation ? `
                                 <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-lg p-3 border border-blue-400/30">
                                     <h4 class="text-white font-medium mb-2 flex items-center">
                                         <i class="fas fa-robot mr-2 text-blue-300"></i>
                                         AI Security Analysis
                                     </h4>
                                     <div class="text-white text-sm leading-relaxed whitespace-pre-wrap max-h-96 overflow-y-auto bg-black/20 p-3 rounded border">${response.aiExplanation}</div>
                                 </div>
                             ` : ''}
                             
                             ${hasAIError ? `
                                 <div class="bg-yellow-500/20 rounded-lg p-3 border border-yellow-400/30">
                                     <h4 class="text-yellow-200 font-medium mb-2">‚ö†Ô∏è AI Processing Failed</h4>
                                     <p class="text-yellow-100 text-sm">${response.aiError}</p>
                                     <p class="text-yellow-200 text-xs mt-2">Showing raw response below...</p>
                                 </div>
                             ` : ''}
                             
                             <div class="bg-white/10 rounded-lg p-3">
                                 <h4 class="text-white font-medium mb-2">Request URL</h4>
                                 <code class="text-green-300 text-xs break-all">${response.url}</code>
                                 ${response.method === 'proxy' ? '<p class="text-blue-200 text-xs mt-1">‚úÖ Request sent via proxy (CORS bypassed)</p>' : ''}
                             </div>
                             
                             <div class="bg-white/10 rounded-lg p-3">
                                 <h4 class="text-white font-medium mb-2">Response Status</h4>
                                 <span class="px-2 py-1 rounded text-sm ${response.status < 400 ? 'bg-green-600' : 'bg-red-600'} text-white">
                                     ${response.status} ${response.statusText}
                                 </span>
                             </div>
                             
                             ${!hasAIExplanation ? `
                                 <div class="bg-white/10 rounded-lg p-3">
                                     <h4 class="text-white font-medium mb-2">Response Headers</h4>
                                     <pre class="text-blue-300 text-xs bg-black/30 p-2 rounded overflow-x-auto max-h-32">${JSON.stringify(response.headers, null, 2)}</pre>
                                 </div>
                                 
                                 <div class="bg-white/10 rounded-lg p-3">
                                     <h4 class="text-white font-medium mb-2">Raw Response Data</h4>
                                     <pre class="text-green-300 text-xs bg-black/30 p-2 rounded overflow-x-auto max-h-64">${JSON.stringify(response.data, null, 2)}</pre>
                                 </div>
                             ` : `
                                 <details class="bg-white/5 rounded-lg p-3">
                                     <summary class="text-white font-medium cursor-pointer hover:text-blue-300 transition-colors text-sm">
                                         <i class="fas fa-code mr-2"></i>
                                         View Raw Response Data
                                     </summary>
                                     <div class="mt-3 space-y-3">
                                         <div>
                                             <h5 class="text-white font-medium mb-2 text-sm">Response Headers</h5>
                                             <pre class="text-blue-300 text-xs bg-black/30 p-2 rounded overflow-x-auto max-h-32">${JSON.stringify(response.headers, null, 2)}</pre>
                                         </div>
                                         <div>
                                             <h5 class="text-white font-medium mb-2 text-sm">Response Data</h5>
                                             <pre class="text-green-300 text-xs bg-black/30 p-2 rounded overflow-x-auto max-h-64">${JSON.stringify(response.data, null, 2)}</pre>
                                         </div>
                                     </div>
                                 </details>
                             `}
                         </div>
                     </div>
                 `;
                document.body.appendChild(modal);
                
                // Add keyboard support for closing
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                
                // Focus the close button for accessibility
                setTimeout(() => {
                    const closeBtn = modal.querySelector('button');
                    if (closeBtn) closeBtn.focus();
                }, 100);
            };

            console.log('App component rendering...');
            
            return (
                <div className="min-h-screen py-8 px-4">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <div className="flex justify-between items-center mb-4">
                                <div></div>
                                <h1 className="text-4xl font-bold text-white">
                                    <i className="fas fa-shield-alt mr-3"></i>
                                    TDR Agent
                                </h1>
                                <button
                                    onClick={() => setShowConfig(!showConfig)}
                                    className="text-white hover:text-blue-200 transition-colors"
                                    title="Configure API settings"
                                >
                                    <i className="fas fa-cog text-xl"></i>
                                </button>
                            </div>
                            <p className="text-xl text-blue-100">
                                Natural Language API Query Interface
                            </p>
                            <p className="text-sm text-blue-200 mt-2">
                                Ask questions about threats, users, devices, and security risks in natural language
                            </p>
                        </div>

                        {/* Configuration Modal */}
                        {showConfig && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2">
                                <div className="glass-effect rounded-2xl p-4 w-full max-w-md h-[90vh] flex flex-col">
                                    <div className="flex justify-between items-center mb-3 flex-shrink-0">
                                        <h3 className="text-lg font-semibold text-white">
                                            <i className="fas fa-cog mr-2"></i>
                                            API Configuration
                                        </h3>
                                        <button
                                            onClick={() => setShowConfig(false)}
                                            className="text-white hover:text-red-300 transition-colors text-xl p-1"
                                        >
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto pr-2">
                                        <form onSubmit={updateConfig} className="space-y-3">
                                        <div>
                                            <label className="block text-white text-sm font-medium mb-2">
                                                Target Hostname
                                            </label>
                                            <input
                                                type="text"
                                                value={config.hostname}
                                                onChange={(e) => setConfig({...config, hostname: e.target.value})}
                                                placeholder="e.g., api.example.com:8080"
                                                className="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                                                required
                                            />
                                            <p className="text-xs text-blue-200 mt-1">
                                                Include port if needed (e.g., api.example.com:8080). Uses HTTPS by default.
                                            </p>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-white text-sm font-medium mb-2">
                                                API Token
                                            </label>
                                            <input
                                                type="password"
                                                value={config.api_token}
                                                onChange={(e) => setConfig({...config, api_token: e.target.value})}
                                                placeholder="Enter your API token"
                                                className="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                                            />
                                            <p className="text-xs text-blue-200 mt-1">
                                                This will be sent in the X-API-KEY header
                                            </p>
                                        </div>

                                        <div className="border-t border-white/20 pt-4">
                                            <h4 className="text-white font-medium mb-3">
                                                <i className="fas fa-robot mr-2"></i>
                                                AI Configuration (via OpenRouter) - Optional
                                            </h4>
                                            
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">
                                                        OpenRouter API Key
                                                    </label>
                                                    <input
                                                        type="password"
                                                        value={config.openrouter_api_key || config.openai_api_key || ''}
                                                        onChange={(e) => setConfig({...config, openrouter_api_key: e.target.value})}
                                                        placeholder="sk-or-..."
                                                        className="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                                                    />
                                                    <p className="text-xs text-blue-200 mt-1">
                                                        Your OpenRouter API key (starts with sk-or-). Get it from <a href="https://openrouter.ai" target="_blank" className="underline">openrouter.ai</a>. This key works for both OpenAI and DeepSeek models.
                                                    </p>
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">
                                                        AI Provider (via OpenRouter)
                                                    </label>
                                                    <select
                                                        value={config.ai_provider || 'deepseek'}
                                                        onChange={(e) => {
                                                            const provider = e.target.value;
                                                            const defaultModel = getDefaultModel(provider);
                                                            setConfig({
                                                                ...config, 
                                                                ai_provider: provider,
                                                                openrouter_model: defaultModel
                                                            });
                                                        }}
                                                        className="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                                                    >
                                                        <option value="deepseek">DeepSeek</option>
                                                        <option value="openai">OpenAI</option>
                                                    </select>
                                                    <p className="text-xs text-blue-200 mt-1">
                                                        Choose AI provider (both accessed via OpenRouter)
                                                    </p>
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">
                                                        AI Model
                                                    </label>
                                                    <select
                                                        value={config.openrouter_model || config.openai_model || getDefaultModel(config.ai_provider || 'deepseek')}
                                                        onChange={(e) => setConfig({...config, openrouter_model: e.target.value})}
                                                        className="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                                                    >
                                                        {(modelOptions[config.ai_provider] || modelOptions.deepseek).map((option) => (
                                                            <option key={option.value} value={option.value}>
                                                                {option.label}
                                                            </option>
                                                        ))}
                                                    </select>
                                                    <p className="text-xs text-blue-200 mt-1">
                                                        Choose the {config.ai_provider === 'openai' ? 'OpenAI' : 'DeepSeek'} model via OpenRouter
                                                    </p>
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-white text-sm font-medium mb-2">
                                                        AI API Base URL (OpenRouter)
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={config.openrouter_base_url || config.openai_base_url || 'https://openrouter.ai/api/v1'}
                                                        onChange={(e) => setConfig({...config, openrouter_base_url: e.target.value})}
                                                        placeholder="https://openrouter.ai/api/v1"
                                                        className="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                                                    />
                                                    <p className="text-xs text-blue-200 mt-1">
                                                        OpenRouter API endpoint (default: https://openrouter.ai/api/v1)
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex space-x-3 pt-3 flex-shrink-0">
                                            <button
                                                type="button"
                                                onClick={() => setShowConfig(false)}
                                                className="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm"
                                            >
                                                Cancel
                                            </button>
                                            <button
                                                type="submit"
                                                disabled={configLoading}
                                                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm"
                                            >
                                                {configLoading ? (
                                                    <i className="fas fa-spinner fa-spin mr-2"></i>
                                                ) : (
                                                    <i className="fas fa-save mr-2"></i>
                                                )}
                                                Save
                                            </button>
                                        </div>
                                    </form>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* Query Section */}
                            <div className="lg:col-span-2">
                                <div className="glass-effect rounded-2xl p-6 mb-6">
                                    <h2 className="text-2xl font-semibold text-white mb-4">
                                        <i className="fas fa-comments mr-2"></i>
                                        Ask a Question
                                    </h2>
                                    
                                    <form id="query-form" onSubmit={handleSubmit} className="mb-6">
                                        <div className="relative">
                                            <input
                                                type="text"
                                                value={query}
                                                onChange={(e) => setQuery(e.target.value)}
                                                placeholder="e.g., Show me the most risky users..."
                                                className="query-input w-full px-4 py-3 pr-12 bg-white/90 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                                                disabled={loading}
                                            />
                                            <button
                                                type="submit"
                                                disabled={loading || !query.trim()}
                                                className="absolute right-2 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                            >
                                                {loading ? (
                                                    <i className="fas fa-spinner fa-spin"></i>
                                                ) : (
                                                    <i className="fas fa-search"></i>
                                                )}
                                            </button>
                                        </div>
                                    </form>

                                    {/* Suggestions */}
                                    {suggestions.length > 0 && (
                                        <div>
                                            <h3 className="text-lg font-medium text-white mb-3">
                                                <i className="fas fa-lightbulb mr-2"></i>
                                                Example Queries
                                            </h3>
                                            <div className="grid grid-cols-1 gap-2">
                                                {suggestions.map((suggestion, index) => (
                                                    <button
                                                        key={index}
                                                        onClick={() => handleSuggestionClick(suggestion)}
                                                        className="text-left p-3 bg-white/10 hover:bg-white/20 rounded-lg text-white text-sm transition-colors border border-white/20"
                                                        disabled={loading}
                                                    >
                                                        <i className="fas fa-arrow-right mr-2 text-blue-300"></i>
                                                        {suggestion}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Results */}
                                {error && (
                                    <div className="glass-effect rounded-2xl p-6 mb-6 border border-red-400">
                                        <div className="flex items-center text-red-200">
                                            <i className="fas fa-exclamation-triangle mr-3"></i>
                                            <h3 className="text-lg font-medium">Error</h3>
                                        </div>
                                        <p className="text-red-100 mt-2">{error}</p>
                                    </div>
                                )}

                                {result && (
                                    <div className="glass-effect rounded-2xl p-6">
                                        <h3 className="text-2xl font-semibold text-white mb-4">
                                            <i className="fas fa-code mr-2"></i>
                                            Generated API Request
                                        </h3>
                                        
                                        {result.error ? (
                                            <div className="text-red-200">
                                                <p className="mb-4">{result.error}</p>
                                                {result.suggestions && (
                                                    <div>
                                                        <p className="text-white font-medium mb-2">Try these examples:</p>
                                                        <ul className="list-disc list-inside text-blue-200">
                                                            {result.suggestions.map((suggestion, index) => (
                                                                <li key={index} className="mb-1">{suggestion}</li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            <div className="space-y-6">
                                                {/* Query Summary */}
                                                <div className="bg-white/10 rounded-lg p-4">
                                                    <h4 className="text-white font-medium mb-2">
                                                        <i className="fas fa-quote-left mr-2"></i>
                                                        Your Query
                                                    </h4>
                                                    <p className="text-blue-100">{result.natural_language_query}</p>
                                                    
                                                    {/* Processing Method Indicator */}
                                                    <div className="mt-2 flex items-center space-x-2">
                                                        <span className="text-xs text-blue-200">Processing:</span>
                                                        {result.processing_method === 'rule_based' ? (
                                                            <span className="px-2 py-1 bg-green-600 text-white text-xs rounded">
                                                                <i className="fas fa-cogs mr-1"></i>
                                                                Rule-based
                                                            </span>
                                                        ) : result.processing_method === 'openai' ? (
                                                            <span className="px-2 py-1 bg-purple-600 text-white text-xs rounded">
                                                                <i className="fas fa-robot mr-1"></i>
                                                                AI-powered
                                                                {result.confidence && (
                                                                    <span className="ml-1">({Math.round(result.confidence * 100)}%)</span>
                                                                )}
                                                            </span>
                                                        ) : (
                                                            <span className="px-2 py-1 bg-red-600 text-white text-xs rounded">
                                                                <i className="fas fa-exclamation-triangle mr-1"></i>
                                                                Failed
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* API Endpoint */}
                                                <div className="bg-white/10 rounded-lg p-4">
                                                    <h4 className="text-white font-medium mb-2">
                                                        <i className="fas fa-route mr-2"></i>
                                                        API Endpoint
                                                    </h4>
                                                    <div className="api-endpoint text-green-300 bg-black/30 p-3 rounded border">
                                                        <span className="text-yellow-400">{result.api_request.method}</span> {result.api_request.url}
                                                    </div>
                                                </div>

                                                {/* Extracted Parameters */}
                                                {Object.keys(result.extracted_parameters).length > 0 && (
                                                    <div className="bg-white/10 rounded-lg p-4">
                                                        <h4 className="text-white font-medium mb-2">
                                                            <i className="fas fa-cogs mr-2"></i>
                                                            Extracted Parameters
                                                        </h4>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            {Object.entries(result.extracted_parameters).map(([key, value]) => (
                                                                <div key={key} className="bg-black/20 p-2 rounded">
                                                                    <span className="text-blue-300 font-mono">{key}:</span>
                                                                    <span className="text-white ml-2">{value || 'null'}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Full API Request */}
                                                <div className="bg-white/10 rounded-lg p-4">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h4 className="text-white font-medium">
                                                            <i className="fas fa-code mr-2"></i>
                                                            Complete API Request
                                                        </h4>
                                                        <div className="flex space-x-2">
                                                            <button
                                                                onClick={() => sendApiRequest(result.api_request)}
                                                                className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors"
                                                            >
                                                                <i className="fas fa-paper-plane mr-1"></i>
                                                                Send Request
                                                            </button>
                                                            <button
                                                                onClick={() => copyToClipboard(JSON.stringify(formatApiRequest(result.api_request), null, 2))}
                                                                className="text-blue-300 hover:text-blue-200 transition-colors"
                                                            >
                                                                <i className="fas fa-copy"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="response-section bg-black/30 p-4 rounded border overflow-x-auto">
                                                        <pre className="text-green-300 text-sm">
                                                            {JSON.stringify(formatApiRequest(result.api_request), null, 2)}
                                                        </pre>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* API Response Display */}
                            {apiResponse && (
                                <div className="glass-effect rounded-2xl p-6 mb-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-semibold text-white">
                                            <i className="fas fa-server mr-2"></i>
                                            API Response
                                            {apiResponse.error ? (
                                                <span className="ml-2 text-red-300 text-sm">‚ùå Failed</span>
                                            ) : (
                                                <span className="ml-2 text-green-300 text-sm">‚úÖ Success</span>
                                            )}
                                        </h3>
                                        <div className="flex space-x-2">
                                            {aiExplanation && (
                                                <button
                                                    onClick={() => showAiExplanationModal({
                                                        status: apiResponse.status,
                                                        statusText: apiResponse.statusText,
                                                        data: apiResponse.data,
                                                        aiExplanation: aiExplanation,
                                                        url: apiResponse.url,
                                                        method: apiResponse.method
                                                    })}
                                                    className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors"
                                                >
                                                    <i className="fas fa-robot mr-1"></i>
                                                    View AI Analysis
                                                </button>
                                            )}
                                            <button
                                                onClick={() => setApiResponse(null)}
                                                className="text-gray-400 hover:text-white transition-colors"
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        {/* Response Status */}
                                        <div className="bg-white/10 rounded-lg p-4">
                                            <h4 className="text-white font-medium mb-2">Response Status</h4>
                                            <div className="flex items-center space-x-4">
                                                <span className={`px-3 py-1 rounded text-sm ${apiResponse.status < 400 ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                                                    {apiResponse.status} {apiResponse.statusText}
                                                </span>
                                                <span className="text-blue-200 text-sm">
                                                    <i className="fas fa-link mr-1"></i>
                                                    {apiResponse.url}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Response Data */}
                                        <div className="bg-white/10 rounded-lg p-4">
                                            <h4 className="text-white font-medium mb-2">Response Data</h4>
                                            <pre className="text-green-300 text-sm bg-black/30 p-3 rounded overflow-x-auto max-h-96">
                                                {JSON.stringify(apiResponse.data, null, 2)}
                                            </pre>
                                        </div>

                                        {/* AI Status */}
                                        {aiExplanation ? (
                                            <div className="bg-blue-500/20 rounded-lg p-4 border border-blue-400/30">
                                                <h4 className="text-blue-200 font-medium mb-2">
                                                    <i className="fas fa-robot mr-2"></i>
                                                    AI Analysis Available
                                                </h4>
                                                <p className="text-blue-100 text-sm">
                                                    Click "View AI Analysis" to see the intelligent security analysis of this response.
                                                </p>
                                            </div>
                                        ) : (
                                            <div className="bg-yellow-500/20 rounded-lg p-4 border border-yellow-400/30">
                                                <h4 className="text-yellow-200 font-medium mb-2">
                                                    <i className="fas fa-exclamation-triangle mr-2"></i>
                                                    AI Analysis Not Available
                                                </h4>
                                                <p className="text-yellow-100 text-sm mb-2">
                                                    AI analysis failed or was not requested. Check the console for details.
                                                </p>
                                                <button
                                                    onClick={async () => {
                                                        try {
                                                            console.log('üß™ Testing AI configuration...');
                                                            const response = await fetch('/api/test-ai');
                                                            const result = await response.json();
                                                            console.log('üß™ AI Test Result:', result);
                                                            
                                                            if (result.success) {
                                                                alert('‚úÖ AI Test Successful!\n\n' + JSON.stringify(result, null, 2));
                                                            } else {
                                                                alert('‚ùå AI Test Failed!\n\n' + JSON.stringify(result, null, 2));
                                                            }
                                                        } catch (error) {
                                                            console.error('üß™ AI Test Error:', error);
                                                            alert('‚ùå AI Test Error: ' + error.message);
                                                        }
                                                    }}
                                                    className="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition-colors mr-2"
                                                >
                                                    <i className="fas fa-vial mr-1"></i>
                                                    Test AI Config
                                                </button>
                                                 <button
                                                     onClick={() => {
                                                         console.log('üé≠ Testing AI modal display...');
                                                         const testData = {
                                                             status: 200,
                                                             statusText: 'OK',
                                                             data: { test: 'This is test data' },
                                                             aiExplanation: 'This is a test AI explanation to verify the modal display is working correctly.',
                                                             url: 'http://test.com/api/test',
                                                             method: 'proxy'
                                                         };
                                                         console.log('Test modal data:', testData);
                                                         showAiExplanationModal(testData);
                                                     }}
                                                     className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors mr-2"
                                                 >
                                                     <i className="fas fa-eye mr-1"></i>
                                                     Test Modal
                                                 </button>
                                                 <button
                                                     onClick={async () => {
                                                         if (!apiResponse) {
                                                             alert('No API response available. Please send an API request first.');
                                                             return;
                                                         }
                                                         
                                                         console.log('ü§ñ Manually triggering AI processing...');
                                                         console.log('API Response data:', apiResponse.data);
                                                         
                                                        try {
                                                            // Try to detect language from the original query
                                                            const detectedLanguage = result?.detected_language || 'en';
                                                            const aiExplanation = await processResponseWithAI(apiResponse.data, {
                                                                method: 'GET',
                                                                url: '/threats/org/summary',
                                                                query_params: {}
                                                            }, detectedLanguage);
                                                             
                                                             console.log('‚úÖ Manual AI Processing Successful');
                                                             console.log('AI Explanation:', aiExplanation);
                                                             
                                                             setAiExplanation(aiExplanation);
                                                             
                                                             // Show AI explanation modal
                                                             showAiExplanationModal({
                                                                 status: apiResponse.status,
                                                                 statusText: apiResponse.statusText,
                                                                 data: apiResponse.data,
                                                                 aiExplanation: aiExplanation,
                                                                 url: apiResponse.url,
                                                                 method: apiResponse.method
                                                             });
                                                             
                                                         } catch (error) {
                                                             console.error('‚ùå Manual AI Processing Failed:', error);
                                                             alert('AI processing failed: ' + error.message);
                                                         }
                                                     }}
                                                     className="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors"
                                                 >
                                                     <i className="fas fa-magic mr-1"></i>
                                                     Force AI Analysis
                                                 </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Sidebar */}
                            <div className="lg:col-span-1">
                                {/* Available Endpoints */}
                                <div className="glass-effect rounded-2xl p-6">
                                    <h3 className="text-xl font-semibold text-white mb-4">
                                        <i className="fas fa-list mr-2"></i>
                                        Available Endpoints
                                    </h3>
                                    <div className="space-y-3">
                                        {endpoints.map((endpoint, index) => (
                                            <div key={index} className="bg-white/10 rounded-lg p-3">
                                                <div className="flex items-center mb-2">
                                                    <span className={`px-2 py-1 rounded text-xs font-mono ${
                                                        endpoint.method === 'GET' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'
                                                    }`}>
                                                        {endpoint.method}
                                                    </span>
                                                </div>
                                                <div className="text-blue-300 font-mono text-sm mb-1">
                                                    {endpoint.path}
                                                </div>
                                                <div className="text-white text-sm">
                                                    {endpoint.summary}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* API Info */}
                                <div className="glass-effect rounded-2xl p-6 mt-6">
                                    <h3 className="text-xl font-semibold text-white mb-4">
                                        <i className="fas fa-info-circle mr-2"></i>
                                        About This API
                                    </h3>
                                    <div className="text-blue-100 text-sm space-y-2">
                                        <p><strong>Title:</strong> OpenText Core Threat Detection and Response</p>
                                        <p><strong>Version:</strong> 1.7.25</p>
                                        <p><strong>Purpose:</strong> Analyze security threats, risky users, devices, and processes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app with error boundary
        console.log('Starting React app render...');
        try {
            ReactDOM.render(
                <ErrorBoundary>
                    <App />
                </ErrorBoundary>, 
                document.getElementById('root')
            );
            console.log('React app rendered successfully');
        } catch (error) {
            console.error('Error rendering React app:', error);
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-red-500 text-white">
                    <div class="text-center p-8">
                        <h1 class="text-2xl mb-4">React Render Error</h1>
                        <p class="mb-4">Error: ${error.message}</p>
                        <button onclick="window.location.reload()" class="bg-white text-red-500 px-4 py-2 rounded hover:bg-gray-100">
                            Reload Page
                        </button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
